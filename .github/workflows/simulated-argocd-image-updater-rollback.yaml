name: Simulate ArgoCD Image Updater

on:
  push:
    branches: [main]

jobs:
  image-updater-simulation:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Install kubectl, kind, and Helm
      - name: Install Kubernetes tools
        run: |
          curl -sLo kubectl https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLo kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x kind && sudo mv kind /usr/local/bin/
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # 4. Create a temporary Kind cluster
      - name: Create Kind cluster
        run: |
          kind create cluster --name argocd-cluster

      # 5. Start a local Docker registry for Image Updater to watch
      - name: Start Local Registry
        run: |
          docker run -d -p 5000:5000 --name registry registry:2
          docker network connect kind registry || true

      # 6. Install ArgoCD
      - name: Install ArgoCD
        run: |
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          kubectl wait --for=condition=available --timeout=120s deployment/argocd-server -n argocd

      # 7. Install ArgoCD Image Updater
      - name: Install ArgoCD Image Updater
        run: |
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/master/manifests/install.yaml
          kubectl wait --for=condition=available --timeout=120s deployment/argocd-image-updater -n argocd

      # 8. Build and push initial (1.0.0) image to local registry
      - name: Build Initial Image
        run: |
          docker build -t localhost:5000/weather-app:1.0.0 -f Dockerfile.good .
          docker push localhost:5000/weather-app:1.0.0

      # 9. Create helms namespace
      - name: Create helms namespace
        run: kubectl create namespace helms || true

      # 10. Deploy Application with ArgoCD + annotations for Image Updater
      - name: Deploy ArgoCD Application
        run: |
          kubectl apply -f - <<'EOF'
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: weather-app-helms
            namespace: argocd
            annotations:
              argocd-image-updater.argoproj.io/image-list: weather-app=localhost:5000/weather-app
              argocd-image-updater.argoproj.io/weather-app.update-strategy: latest
              argocd-image-updater.argoproj.io/weather-app.helm.image-name: image.repository
              argocd-image-updater.argoproj.io/weather-app.helm.image-tag: image.tag
          spec:
            project: default
            source:
              repoURL: https://github.com/doyinhubx/weather-runner.git
              targetRevision: main
              path: weather-app-helms
              helm:
                values: |
                  image:
                    repository: localhost:5000/weather-app
                    tag: "1.0.0"
                    pullPolicy: IfNotPresent
            destination:
              server: https://kubernetes.default.svc
              namespace: helms
            syncPolicy:
              automated:
                selfHeal: true
                prune: true
          EOF

      # 11. Build and push newer (2.0.0) image to local registry
      - name: Build Newer Image
        run: |
          docker build -t localhost:5000/weather-app:2.0.0 -f Dockerfile.good .
          docker push localhost:5000/weather-app:2.0.0

      # 12. Wait for Deployment to appear before polling
      - name: Wait for Deployment
        run: |
          echo "⏳ Waiting for weather-app-helms deployment to be created..."
          kubectl rollout status deployment/weather-app-helms -n helms --timeout=90s || true

      # 13. Wait for Image Updater to detect new tag
      - name: Wait for ArgoCD Image Updater
        run: |
          echo "⏳ Waiting up to 90s for Image Updater to update the Application..."
          for i in {1..9}; do
            FINAL_IMAGE=$(kubectl get deployment weather-app-helms -n helms -o jsonpath="{.spec.template.spec.containers[0].image}" || echo "")
            echo "Current image: $FINAL_IMAGE"
            if [[ "$FINAL_IMAGE" == *":2.0.0" ]]; then
              echo "✅ Image Updater successfully updated to 2.0.0!"
              exit 0
            fi
            sleep 10
          done
          echo "❌ Image Updater did not update to 2.0.0 in time"
          exit 1

      # 14. Final pod status
      - name: Final Pod Status
        run: kubectl get pods -n helms -o wide
