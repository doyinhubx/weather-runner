name: Deploy and Test Rollback on Kind 

on:
  push:
    branches: [main]

jobs:
  deploy-rollback:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Install kubectl, kind, and Helm
      - name: Install Kubernetes tools
        run: |
          echo "🔧 Installing kubectl, kind, and Helm..."
          curl -sLo kubectl https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLo kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x kind && sudo mv kind /usr/local/bin/
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # 4. Create a temporary Kind cluster
      - name: Create Kind cluster
        run: |
          echo "🚀 Creating Kind cluster: test-cluster..."
          kind create cluster --name test-cluster
          echo "✅ Kind cluster created!"

      # 5. Load Docker images into Kind
      - name: Build and load working image
        run: |
          echo "📦 Building working image..."
          docker build -f Dockerfile.working -t weather-app:working .
          echo "📥 Loading working image into Kind..."
          kind load docker-image weather-app:working --name test-cluster
          echo "✅ Working image ready!"

      - name: Build and load failing image
        run: |
          echo "📦 Building failing image..."
          docker build -f Dockerfile.failing -t weather-app:failing .
          echo "📥 Loading failing image into Kind..."
          kind load docker-image weather-app:failing --name test-cluster
          echo "✅ Failing image loaded (for simulation)."

      # 6. Deploy working image via Helm
      - name: Deploy working image
        run: |
          echo "🚀 Deploying working release..."
          helm upgrade --install weather-app ./weather-app-helms \
            --namespace default \
            --set image.repository=weather-app \
            --set image.tag=working \
            --wait --timeout 3m
          echo "✅ Working release deployed successfully."

      # 7. Verify deployment succeeded
      - name: Verify deployment
        run: |
          echo "🔍 Verifying working pod status..."
          for i in {1..12}; do
            STATUS=$(kubectl get pods -l app=weather-app -o jsonpath="{.items[0].status.phase}")
            if [[ "$STATUS" == "Running" ]]; then
              echo "✅ Pod is running (healthy deployment)."
              exit 0
            fi
            echo "⏳ Waiting for pod... ($i/12)"
            sleep 10
          done
          echo "❌ Initial deployment failed!"
          exit 1

      # 8. Deploy failing image to simulate failure
      - name: Deploy failing image
        run: |
          echo "🚨 Deploying failing release..."
          helm upgrade --install weather-app ./weather-app-helms \
            --namespace default \
            --set image.repository=weather-app \
            --set image.tag=failing \
            --wait --timeout 3m || echo "⚠️ Deployment failed as expected"

      # 9. Post-Deployment Health Check & Automated Rollback
      - name: Verify Deployment Health and Rollback if Failed
        run: |
          echo "🔍 Running post-deployment health checks..."
          FAILED=1
          for i in {1..12}; do
            STATUS=$(kubectl get pods -l app=weather-app -o jsonpath="{.items[0].status.phase}" 2>/dev/null || echo "NotReady")
            echo "📊 Current pod status: $STATUS"
            if [[ "$STATUS" == "Running" ]]; then
              echo "✅ Pod is running (deployment succeeded)."
              FAILED=0
              break
            fi
            echo "⏳ Waiting for pod to be ready... ($i/12)"
            sleep 10
          done

          if [[ $FAILED -eq 1 ]]; then
            echo "❌ Deployment failed health check!"
            echo "🔄 Triggering rollback..."
            kubectl rollout undo deployment/weather-app || echo "⚠️ No rollback needed (maybe first deploy)"
            echo "✅ Rollback completed. Cluster restored to last good state."
            exit 1
          fi

          
      # 10. Delete kind cluster (cleanup)
      - name: Cleanup Kind Cluster
        if: always()
        run: |
          echo "🧹 Cleaning up Kind cluster..."
          kind delete cluster --name test-cluster
          echo "✅ Kind cluster deleted."
